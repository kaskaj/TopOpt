\newpage
\chapter{Topology optimization}

\section{Problem formulation in continuous space}

\begin{align*} 
\mathrm{minimize}\quad  &  F_y^p \quad \mathrm{(p\,-\,plunger)} \\
\mathrm{subject \, to}\quad  & - \frac{1}{\mu} \Delta A = J \\
&  B_x = \partial_y A \\
&  B_y = - \partial_x A
\end{align*}

\begin{equation} \label{eq:43} 
F_y^p = \left(0,1\right) \int_{\Omega_p} \left( \nabla \cdot \mathbb{T} \right) \,\mathrm{d}S = \int_{\Omega_p} \frac{1}{\mu_0} \left( \partial_y B_y B_y - \partial_y B_x B_x + \partial_x B_x B_y + \partial_x B_y B_x \right) \,\mathrm{d}S
\end{equation}

\section{Problem formulation in discrete space}

\begin{align*} 
\mathrm{minimize}\quad  &  F_y^p \\
\mathrm{subject \, to}\quad  &  S A = M J \\
&  M B_x = C_y A \\
&  M B_y = -C_x A 
\end{align*}


\begin{equation} \label{eq:44} 
F_y^p = \frac{1}{\mu_0} \left(B_y^{\top} C_y^p B_y - B_x^{\top} C_y^p B_x + B_y^{\top} C_x^p B_x + B_x^{\top} C_x^p B_y \right)
\end{equation}

\noindent Lagrange multipliers are $\left(\alpha, \beta, \gamma \right)$.

\begin{align*} 
S A = M J \quad &\rightarrow \quad \alpha \\
M B_x = C_y A \quad &\rightarrow \quad \beta \\
M B_y = -C_x A \quad &\rightarrow \quad \gamma \\
\end{align*}

\noindent The $\varphi$ is the topology function.

\begin{equation} \label{eq:46} 
J\left(\varphi\right) = J_1\left(\varphi\right) + J_2\left(\varphi\right) + J_3\left(\varphi\right) + J_4\left(\varphi\right)
\end{equation}

\begin{align*} 
J_1 &= \frac{1}{\mu_0} \left(B_y^{\top} \left( \varphi \right) C_y^p B_y \left( \varphi \right) - B_x^{\top} \left( \varphi \right) C_y^p B_x \left( \varphi \right) + B_y^{\top} \left( \varphi \right) C_x^p B_x \left( \varphi \right) + B_x^{\top} \left( \varphi \right) C_x^p B_y \left( \varphi \right) \right) \numberthis \label{eq:49} \\
J_2 &= \alpha^{\top} \left(S \left( \varphi \right) A \left( \varphi \right) - M J \left( \varphi \right) \right) = 0 \numberthis \label{eq:50} \\
J_3 &= \beta^{\top} \left(M B_x \left( \varphi \right) - C_y A \left( \varphi \right) \right) = 0 \numberthis \label{eq:51} \\ 
J_4 &= \gamma^{\top} \left(M B_y \left( \varphi \right) + C_x A \left( \varphi \right) \right) = 0 \numberthis \label{eq:51}
\end{align*}

\begin{equation} \label{eq:48} 
\partial_{\varphi_i} J\left(\varphi\right) = \partial_{\varphi_i} J_1\left(\varphi\right) + \partial_{\varphi_i} J_2\left(\varphi\right) + \partial_{\varphi_i} J_3\left(\varphi\right) + \partial_{\varphi_i} J_4\left(\varphi\right)
\end{equation}

\begin{equation} \label{eq:49} 
\mu_0 \partial_{\varphi_i} J_1 = \partial_{\varphi_i} \left( B_y^{\top} C_y^p  B_y \right) - \partial_{\varphi_i} \left( B_x^{\top} C_y^p B_x \right) + \partial_{\varphi_i} \left( B_y^{\top} C_x^p B_x \right) + \partial_{\varphi_i} \left( B_x^{\top} C_x^p B_y \right)
\end{equation}

\begin{equation} \label{eq:50} 
\partial_{\varphi_i} \left( B_y^{\top} C_y^p  B_y \right) = \partial_{\varphi_i} B_y^{\top} C_y^p B_y +  B_y^{\top} C_y^p \partial_{\varphi_i} B_y  = B_y^{\top} \left( C_y^p \right)^{\top} \partial_{\varphi_i} B_y + B_y^{\top} C_y^p \partial_{\varphi_i} B_y
\end{equation}

\begin{align*} 
\partial_{\varphi_i} J_1 = &\frac{1}{\mu_0} \left(B_x^{\top}, B_y^{\top}\right) \begin{pmatrix} -\left(C_y^p\right)^{\top} -C_y^p \\ \left(C_x^p\right)^{\top} + C_x^p \\ \end{pmatrix} \partial_{\varphi_i} B_x \\
&+ \frac{1}{\mu_0} \left(B_x^{\top}, B_y^{\top}\right) \begin{pmatrix} \left(C_x^p\right)^{\top} + C_x^p \\ \left(C_y^p\right)^{\top} + C_y^p \\ \end{pmatrix}  \partial_{\varphi_i} B_y  \numberthis \label{eq:49} \\
\end{align*}


\begin{align*} 
\partial_{\varphi_i} J_2 &= \alpha^{\top} \partial_{\varphi_i} \left(S A\right) = \alpha^{\top} \partial_{\varphi_i} S A + \alpha^{\top} S \partial_{\varphi_i} A \numberthis \label{eq:50} \\
\partial_{\varphi_i} J_3 &= \beta^{\top} M \partial_{\varphi_i} B_x - \beta^{\top} C_y \partial_{\varphi_i} A \numberthis \label{eq:51} \\ 
\partial_{\varphi_i} J_4 &= \gamma^{\top} M \partial_{\varphi_i} B_y + \gamma^{\top} C_x \partial_{\varphi_i} A \numberthis \label{eq:51}
\end{align*}

\begin{align*}
\partial_{\varphi_i} B_x:& \quad \frac{1}{\mu_0} \left(B_x^{\top}, B_y^{\top}\right) \begin{pmatrix} -\left(C_y^p\right)^{\top} -C_y^p \\ \left(C_x^p\right)^{\top} + C_x^p \\ \end{pmatrix} \partial_{\varphi_i} B_x + \beta^{\top} M \partial_{\varphi_i} B_x \numberthis \label{eq:52}  \\
\partial_{\varphi_i} B_y:& \quad \frac{1}{\mu_0} \left(B_x^{\top}, B_y^{\top}\right) \begin{pmatrix} \left(C_x^p\right)^{\top} + C_x^p \\ \left(C_y^p\right)^{\top} + C_y^p \\ \end{pmatrix}  \partial_{\varphi_i} B_y + \gamma^{\top} M \partial_{\varphi_i} B_y  \numberthis \label{eq:53} \\
\partial_{\varphi_i} A:& \quad \alpha^{\top} S \partial_{\varphi_i} A - \beta^{\top} C_y \partial_{\varphi_i} A + \gamma^{\top} C_x \partial_{\varphi_i} A  \numberthis \label{eq:54} \\
\partial_{\varphi_i} S:& \quad \alpha^{\top} \partial_{\varphi_i} S A  \numberthis \label{eq:55} 
\end{align*}

\noindent If we choose $\alpha, \beta, \gamma$ such that  (\ref{eq:52}), (\ref{eq:53}) and (\ref{eq:54}) are equal to $0$, then: 

\noindent From (\ref{eq:52}), ($M^{\top} = M$, $S^{\top} = S$ ): 
\begin{equation} \label{eq:56} 
\beta = - \frac{1}{\mu_0} M^{-1} \begin{pmatrix} -\left(C_y^p\right)^{\top} -C_y^p \\ \left(C_x^p\right)^{\top} + C_x^p \\ \end{pmatrix}^{\top} \begin{pmatrix} B_x \\ B_y  \end{pmatrix}
\end{equation}

\noindent From (\ref{eq:53}): 
\begin{equation} \label{eq:57} 
\gamma = - \frac{1}{\mu_0} M^{-1} \begin{pmatrix} \left(C_x^p\right)^{\top} + C_x^p \\ \left(C_y^p\right)^{\top} + C_y^p \\ \end{pmatrix}^{\top} \begin{pmatrix} B_x \\ B_y \end{pmatrix}
\end{equation}

\noindent From (\ref{eq:54}): 
\begin{equation} \label{eq:58} 
\alpha =  S^{-1} \left( C_y^{\top} \beta - C_x^{\top} \gamma \right)
\end{equation}

\begin{equation} \label{eq:59} 
\partial_{\varphi_i} J = \alpha^{\top} \partial_{\varphi_i} S A 
\end{equation}

In the linear case the term $\mu_{Fe}$ corresponds to $\mu_0 \mu_r$, in nonlinear case, $\mu_{Fe}$ is function of $A$ and BH curve of the material. Matrix $\hat{S}$ is no longer dependent on $\varphi$.

\begin{equation} \label{eq:60} 
S = \frac{1}{\mu} \hat{S}  = \left(\left(1 - \varphi\right)\mu_0 + \varphi^p \mu_{Fe} \right)^{-1} \hat{S}
\end{equation}

\noindent Linear case:

\begin{equation} \label{eq:61} 
\partial_{\varphi_i} S = \partial_{\varphi_i} \frac{1}{\mu} \hat{S} = \frac{ \mu_0 - p \varphi_i^{p-1} \mu_{Fe}} {\left(\left(1 - \varphi\right)\mu_0 + \varphi^p \mu_{Fe} \right)^{2}} \hat{S}
\end{equation}

\noindent If matrix $S$ is dependent on $A$, the expression (\ref{eq:50}) must be extended. We modify the formula to  differentiate with respect to $A$, which we will use in the future.

\begin{equation} \label{eq:63} 
\partial_{\varphi_i} J_2 = \alpha^{\top} \partial_{\varphi_i} \left(S A\right) = \alpha^{\top} \partial_{A\left(\varphi_i\right)} \left( S A \right) \partial_{\varphi_i} A + \alpha^{\top} \partial_{\varphi_i} S A
\end{equation}


\begin{equation} \label{eq:64} 
\partial_{A} \left(S A\right) = \partial_{A} S A + S \partial_{A} A =  \partial_{A} S A + S
\end{equation}

\noindent In this case, the BH curve is the curve that returns $\mu_{Fe}$ for the given $||B||$. To avoid square root in $||B|| = \sqrt{B_x^2 + B_y^2}$, the curve is defined directly for $B_x^2 + B_y^2$. The magnetic flux density $B_x$ is equal to $C_y A$ and $B_y$ is equal to $C_x A$, then:

\begin{equation} \label{eq:65} 
\partial_{A} S = \frac{-\varphi^p \partial_{A} \mu_{Fe} 
\left(2 C_y A C_y + 2 C_x A C_x \right) } {\left(\left(1 - \varphi\right)\mu_0 + \varphi^p \mu_{Fe} \right)^{2}} \hat{S}
\end{equation}

\noindent New $\alpha$:

\begin{align*}
\partial_{\varphi_i} A: \quad \partial_{A} S A \partial_{\varphi_i} A + S \partial_{\varphi_i} A  - \beta^{\top} C_y \partial_{\varphi_i} A + \gamma^{\top} C_x \partial_{\varphi_i} A  \numberthis \label{eq:66} \\
\alpha = \left(\partial_{A} S A + S \right)^{-1} \left( C_y^{\top} \beta - C_x^{\top} \gamma \right)
\end{align*}

\noindent Motor:

\section{Problem formulation in continuous space}

\begin{align*} 
\mathrm{minimize}\quad  &  T^r \quad \mathrm{(r\,-\,rotor)} \\
\mathrm{subject \, to}\quad  & - \frac{1}{\mu} \Delta A = J \\
&  B_x = \partial_y A \\
&  B_y = - \partial_x A
\end{align*}

\begin{equation} \label{eq:43} 
T^r = \frac{L}{\mu_0\,\left(r_{out} - r_{in}\right)}\, \int_{\Omega_d} r \left(  B_x \,\frac{x}{r} + B_y \,\frac{y}{r} \right) \left( - B_x \,\frac{y}{r} + B_y \,\frac{x}{r} \right) \,\mathrm{d}S
\end{equation}

\section{Problem formulation in discrete space}

\begin{align*} 
\mathrm{minimize}\quad  &  T^r \\
\mathrm{subject \, to}\quad  &  S A = M J \\
&  M B_x = C_y A \\
&  M B_y = -C_x A 
\end{align*}


\begin{equation} \label{eq:44} 
T^r = \frac{L}{\mu_0\,\left(r_{out} - r_{in}\right)} \, r \, \left( \left(  B_x \,\frac{x}{r} + B_y \,\frac{y}{r} \right)^\top M^r \left( - B_x \,\frac{y}{r} + B_y \,\frac{x}{r} \right) \right)
\end{equation}


\begin{equation}
J_1 =\frac{L}{\mu_0\,\left(r_{out} - r_{in}\right)} \, r \, \left( \left(  B_x \left(\varphi\right) \,\frac{x}{r} + B_y \left(\varphi\right) \,\frac{y}{r} \right)^\top M^r \left( - B_x \left(\varphi\right) \,\frac{y}{r} + B_y \left(\varphi\right) \,\frac{x}{r} \right) \right)
\end{equation}

\begin{align*}
&\frac{\mu_0\,\left(r_{out} - r_{in}\right)}{L\,r} J_1 =  \left(  B_x \left(\varphi\right) \,\frac{x}{r} + B_y \left(\varphi\right) \,\frac{y}{r} \right)^\top M^r \left( - B_x \left(\varphi\right) \,\frac{y}{r} + B_y \left(\varphi\right) \,\frac{x}{r} \right) = \\
 - &\left(B_x \frac{x}{r}\right)^\top M^r \left(B_x \frac{y}{r}\right) + \left(B_x \frac{x}{r}\right)^\top M^r \left(B_y \frac{x}{r}\right) - \\
&\left(B_y \frac{y}{r}\right)^\top M^r \left(B_x \frac{y}{r}\right) + \left(B_y \frac{y}{r}\right)^\top M^r \left(B_y \frac{x}{r}\right) = \\
 - &\left(\frac{x}{r}\right)^\top B_x^\top  M^r \left(\frac{y}{r}\right) B_x  + \left(\frac{x}{r}\right)^\top B_x^\top  M^r \left( \frac{x}{r}\right) B_y  - \\
&\left(\frac{y}{r}\right)^\top B_y^\top  M^r \left(\frac{y}{r}\right) B_x  + \left(\frac{y}{r}\right)^\top B_y^\top M^r \left( \frac{x}{r}\right) B_y 
\end{align*}

\begin{align*}
&\frac{\mu_0\,\left(r_{out} - r_{in}\right)}{L\,r} \partial_{\varphi_i} J_1 = - \left(\frac{x}{r}\right)^\top \partial_{\varphi_i} B_x^\top  M^r \left(\frac{y}{r}\right) B_x  - \left(\frac{x}{r}\right)^\top  B_x^\top  M^r \left(\frac{y}{r}\right) \partial_{\varphi_i} B_x  + \\
&\left(\frac{x}{r}\right)^\top  \partial_{\varphi_i} B_x^\top  M^r \left( \frac{x}{r}\right) B_y   + \left(\frac{x}{r}\right)^\top B_x^\top  M^r \left( \frac{x}{r}\right)  \partial_{\varphi_i} B_y  - \\
&\left(\frac{y}{r}\right)^\top \partial_{\varphi_i} B_y^\top  M^r \left(\frac{y}{r}\right) B_x  - \left(\frac{y}{r}\right)^\top B_y^\top  M^r \left(\frac{y}{r}\right) \partial_{\varphi_i} B_x  + \\
&\left(\frac{y}{r}\right)^\top \partial_{\varphi_i} B_y^\top M^r \left( \frac{x}{r}\right) B_y  + \left(\frac{y}{r}\right)^\top B_y^\top M^r \left( \frac{x}{r}\right) \partial_{\varphi_i} B_y 
\end{align*}







